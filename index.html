<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tiomila Results Search</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon192x192.png" type="image/png" sizes="192x192" />
</head>

<body>
    <h1>
        <img src="favicon192x192.png" alt="Logo" style="height: 2em; vertical-align: middle;"> 
        Tiomila Results Search
    </h1>
    <p class="subtitle">Explore results from <strong>2013</strong> to <strong>2024</strong>.</p>
    <div id="statusMessage" class="status-message">Loading data...</div>
    <input type="text" id="searchBox" placeholder="Type a club name..." />
    <div id="results"></div>

    <div class="donation-button">
        <a href="https://www.paypal.com/paypalme/SebastianInderst" target="_blank" rel="noopener noreferrer">
            <button>🍫 Paypal me a carbogel</button>
        </a>
        <p>or support via Swish:</p>
        <img src="swish-qr.png" alt="Swish QR Code" style="width: 150px; height: auto;">
    </div>

    <script>
        let data = {};

        async function loadData() {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = 'Loading data...';

            try {
                const resultsRes = await fetch('gathered_results.json');
                data = await resultsRes.json();

                const clubCount = Object.keys(data).length;
                statusMessage.textContent = `Data loaded successfully. ${clubCount} clubs available.`;
            } catch (error) {
                statusMessage.textContent = 'Error loading data. Please try again.';
                console.error('Error loading data:', error);
            }
        }

        function fuzzySearch(input, clubNames) {
            const normalizedInput = input.toLowerCase().replace(/[-\s]+/g, '');
            return clubNames.filter(name =>
                name.toLowerCase().replace(/[-\s]+/g, '').includes(normalizedInput)
            );
        }

        function displayResults(clubName) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            const clubData = Object.values(data).find(club => club.names.includes(clubName));
            if (!clubData) {
                // Perform fuzzy search for suggestions
                const allClubNames = Object.values(data).flatMap(club => club.names);
                const suggestions = fuzzySearch(clubName, allClubNames);

                if (suggestions.length > 0) {
                    const suggestionList = document.createElement('ul');
                    suggestionList.className = 'suggestion-list';

                    suggestions.forEach(suggestion => {
                        const suggestionItem = document.createElement('li');
                        suggestionItem.className = 'suggestion-item';
                        suggestionItem.textContent = suggestion;

                        suggestionItem.addEventListener('click', () => {
                            document.getElementById('searchBox').value = suggestion;
                            displayResults(suggestion);
                        });

                        suggestionList.appendChild(suggestionItem);
                    });

                    resultsDiv.appendChild(suggestionList);
                } else {
                    resultsDiv.textContent = `No results found for "${clubName}".`;
                }

                return;
            }

            const clubHeader = document.createElement('div');
            clubHeader.className = 'club-header';
            clubHeader.textContent = `📊 Results for ${clubName}`;
            resultsDiv.appendChild(clubHeader);

            for (const [relay, years] of Object.entries(clubData.results)) {
                const relayHeader = document.createElement('div');
                relayHeader.className = 'relay-header';
                relayHeader.innerHTML = `🔁 <strong>${relay}</strong>`;
                resultsDiv.appendChild(relayHeader);

                // Calculate the best result for the relay
                let bestResultPosition = Infinity;
                const bestResults = [];

                for (const [year, teams] of Object.entries(years)) {
                    for (const [teamName, result] of Object.entries(teams)) {
                        if (result.result_position && result.result_position < bestResultPosition) {
                            bestResultPosition = result.result_position;
                            bestResults.length = 0; // Clear previous best results
                            bestResults.push({ year, teamName });
                        } else if (result.result_position === bestResultPosition) {
                            bestResults.push({ year, teamName });
                        }
                    }
                }

                // Display the best result(s)
                if (bestResults.length > 0) {
                    const bestResultDiv = document.createElement('div');
                    bestResultDiv.className = 'best-result';
                    bestResultDiv.innerHTML = `🏆 <strong>Best Result: #${bestResultPosition}</strong>`;

                    bestResults.forEach(({ year, teamName }) => {
                        const bestResultItem = document.createElement('div');
                        bestResultItem.className = 'best-result-item';
                        bestResultItem.textContent = `🎉 Year: ${year}, Team: ${teamName}`;
                        bestResultDiv.appendChild(bestResultItem);
                    });

                    resultsDiv.appendChild(bestResultDiv);
                }

                // Display results for each year
                for (const year of Object.keys(years).sort()) {
                    const yearDiv = document.createElement('div');
                    yearDiv.className = 'result-year';
                    yearDiv.innerHTML = `🗓️ <strong>${year}</strong>`;

                    for (const [teamName, result] of Object.entries(years[year])) {
                        const teamDiv = document.createElement('div');
                        teamDiv.className = 'result-team';
                        teamDiv.textContent = `🏃 ${result.result_position ? `#${result.result_position}` : result.status}: ${teamName}`;
                        yearDiv.appendChild(teamDiv);
                    }

                    resultsDiv.appendChild(yearDiv);
                }
            }
        }

        document.getElementById('searchBox').addEventListener('input', (e) => {
            const club = e.target.value.trim();
            if (club.length > 2) {
                displayResults(club);
            } else {
                document.getElementById('results').innerHTML = '';
            }
        });

        loadData();
    </script>
</body>

</html>